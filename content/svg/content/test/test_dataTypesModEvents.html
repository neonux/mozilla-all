<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<!--
https://bugzilla.mozilla.org/show_bug.cgi?id=629200
-->
<head>
  <title>Test for Bug 629200</title>
  <script type="application/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
  <script type="application/javascript" src="MutationEventChecker.js"></script>
  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
</head>
<body>
<a target="_blank"
  href="https://bugzilla.mozilla.org/show_bug.cgi?id=629200">Mozilla
  Bug 629200</a>
<p id="display"></p>
<div id="content" style="display: none"></div>

<iframe id="svg" src="dataTypes-helper.svg"></iframe>

<pre id="test">
<script class="testbody" type="application/javascript">
SimpleTest.waitForExplicitFinish();

function runTests()
{
  var doc = $("svg").contentWindow.document;
  var filter = doc.getElementById("filter");
  var convolve = doc.getElementById("convolve");
  var blur = doc.getElementById("blur");
  var marker = doc.getElementById("marker");
  var eventChecker = new MutationEventChecker;

  // length attribute

  eventChecker.watchAttr(marker, "markerWidth");
  eventChecker.expect("add modify modify modify modify modify remove add");
  marker.setAttribute("markerWidth", "12.5");
  marker.markerWidth.baseVal.value = 8;
  marker.markerWidth.baseVal.valueInSpecifiedUnits = 9;
  marker.markerWidth.baseVal.valueAsString = "10";
  marker.markerWidth.baseVal.convertToSpecifiedUnits(
    SVGLength.SVG_LENGTHTYPE_CM);
  marker.markerWidth.baseVal.newValueSpecifiedUnits(
    SVGLength.SVG_LENGTHTYPE_MM, 11);
  marker.removeAttribute("markerWidth");
  marker.markerWidth.baseVal.value = 8;

  eventChecker.expect("remove add modify");
  marker.removeAttribute("markerWidth");
  console.log(marker.getAttribute("markerWidth"));
  marker.markerWidth.baseVal.convertToSpecifiedUnits(
    SVGLength.SVG_LENGTHTYPE_NUMBER);
  console.log(marker.getAttribute("markerWidth"));
  marker.markerWidth.baseVal.value = 8;

  eventChecker.expect("");
  marker.markerWidth.baseVal.value = 8;
  marker.setAttribute("markerWidth", "8");
  marker.markerWidth.baseVal.value = 8;
  marker.markerWidth.baseVal.valueAsString = "8";
  marker.markerWidth.baseVal.convertToSpecifiedUnits(
    SVGLength.SVG_LENGTHTYPE_NUMBER);
  marker.markerWidth.baseVal.newValueSpecifiedUnits(
    SVGLength.SVG_LENGTHTYPE_NUMBER, 8);

  // number attribute

  eventChecker.watchAttr(convolve, "divisor");
  eventChecker.expect("add modify remove add");
  convolve.setAttribute("divisor", "12.5");
  convolve.divisor.baseVal = 6;
  convolve.removeAttribute("divisor");
  convolve.divisor.baseVal = 8;

  eventChecker.expect("");
  convolve.divisor.baseVal = 8;
  convolve.setAttribute("divisor", "8");

  // number-optional-number attribute

  eventChecker.watchAttr(blur, "stdDeviation");
  eventChecker.expect("add modify remove add");
  blur.setAttribute("stdDeviation", "5, 6");
  blur.stdDeviationX.baseVal = 8;
  blur.removeAttribute("stdDeviation");
  blur.setAttribute("stdDeviation", "2, 3");

  eventChecker.expect("");
  blur.stdDeviationX.baseVal = 2;
  blur.stdDeviationY.baseVal = 3;
  blur.setAttribute("stdDeviation", "2, 3");

  // integer attribute

  eventChecker.watchAttr(convolve, "targetX");
  eventChecker.expect("add modify remove add");
  convolve.setAttribute("targetX", "12");
  convolve.targetX.baseVal = 6;
  convolve.removeAttribute("targetX");
  convolve.targetX.baseVal = 8;

  // Check redundant change when comparing typed value to attribute value
  eventChecker.expect("");
  convolve.setAttribute("targetX", "8");
  // Check redundant change when comparing attribute value to typed value
  eventChecker.expect("remove add");
  convolve.removeAttribute("targetX");
  convolve.setAttribute("targetX", "8");
  convolve.targetX.baseVal = 8;

  // integer-optional-integer attribute

  eventChecker.watchAttr(filter, "filterRes");
  eventChecker.expect("add modify remove add");
  filter.setAttribute("filterRes", "60, 70");
  filter.filterResX.baseVal = 50;
  filter.removeAttribute("filterRes");
  filter.setAttribute("filterRes", "50, 60");

  eventChecker.expect("");
  filter.filterResX.baseVal = 50;
  filter.setAttribute("filterRes", "50, 60");
  filter.filterResY.baseVal = 60;

  // enum attribute

  eventChecker.watchAttr(convolve, "edgeMode");
  eventChecker.expect("add modify remove add");
  convolve.setAttribute("edgeMode", "none");
  convolve.edgeMode.baseVal = SVGFEConvolveMatrixElement.SVG_EDGEMODE_WRAP;
  convolve.removeAttribute("edgeMode");
  convolve.edgeMode.baseVal = SVGFEConvolveMatrixElement.SVG_EDGEMODE_NONE;

  eventChecker.expect("");
  convolve.edgeMode.baseVal = SVGFEConvolveMatrixElement.SVG_EDGEMODE_NONE;
  convolve.setAttribute("edgeMode", "none");
  convolve.edgeMode.baseVal = SVGFEConvolveMatrixElement.SVG_EDGEMODE_NONE;

  eventChecker.finish();

  SimpleTest.finish();
}

window.addEventListener("load", runTests, false);
</script>
</pre>
</body>
</html>
