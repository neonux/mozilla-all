<html>
<head>
<script>

// Page URL: http://example.org/tests/content/media/video/test/file_access_controls.html

var gTests = [
  {
    url: "redirect.sjs?http://example.com/tests/content/media/video/test/320x240.ogv",
    result: "error",
    description: "Won't load when redirected to different domain",
  },{
    url: "redirect.sjs?http://example.com/tests/content/media/video/test/320x240.allow-origin.ogv",
    result: "loaded",
    description: "Can load when redirected to different domain with allow-origin",
  },{
    url: "redirect.sjs?http://test1.example.org/tests/content/media/video/test/320x240.ogv",
    result: "error",
    description: "Won't load when redirected to subdomain",
  },{
    url: "redirect.sjs?http://test1.example.org/tests/content/media/video/test/320x240.allow-origin.ogv",
    result: "loaded",
    description: "Can load when redirected to subdomain with allow-origin",
  },{
    url: "redirect.sjs?http://example.org/tests/content/media/video/test/320x240.ogv",
    result: "loaded",
    description: "Can load when redirected to same domain",
  },{
    url: "http://example.org/tests/content/media/video/test/320x240.ogv",
    result: "loaded",
    description: "Can load from same domain"
  },{
    url: "http://example.org:8000/tests/content/media/video/test/320x240.ogv",
    result: "error",
    description: "Won't load from differnet port on same domain"
  },{
    url: "http://example.org:8000/tests/content/media/video/test/320x240.allow-origin.ogv",
    result: "loaded",
    description: "Can load from different port on same domain with allow-origin",
  },{
    url: "http://example.com/tests/content/media/video/test/320x240.ogv",
    result: "error",
    description: "Won't load cross domain",
  },{
    url: "http://example.com/tests/content/media/video/test/320x240.allow-origin.ogv",
    result: "loaded",
    description: "Can load cross domain with allow-origin",
  },{
    url: "http://test1.example.org/tests/content/media/video/test/320x240.allow-origin.ogv",
    result: "loaded",
    description: "Can load from subdomain with allow-origin",
  },{
    url: "http://test1.example.org/tests/content/media/video/test/320x240.ogv",
    result: "error",
    description: "Won't load from subdomain",
  }
];

var gTestNum = 0;
var gExpectedResult = null;
var gTestDescription = null;
var video = null;
var gTestedRemoved = false;
var gOldPref;

function result(code) {
  dump((gTestNum - 1) + ": " + code + "\n");
  netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
  opener.is(code, gExpectedResult, gTestDescription);
  nextTest();
}

function load() {
  netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
  opener.is(window.location.href,
            "http://example.org/tests/content/media/video/test/file_access_controls.html",
            "We must be on a example.org:80");
  video = document.getElementById('video');
  
  // Ensure access control check pref is on.
  // media.enforce_same_site_origin
  var prefService = Components.classes["@mozilla.org/preferences-service;1"]
                               .getService(Components.interfaces.nsIPrefService);
  opener.ok(prefService!=null, "Get pref service");
  var branch = prefService.getBranch("media.");
  opener.ok(branch!=null, "Get media pref branch");
  gOldPref = branch.getBoolPref("enforce_same_site_origin");
  branch.setBoolPref("enforce_same_site_origin", true);
  nextTest();
}

function nextTest() {
  netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
  if (gTestNum == gTests.length) {
    if (!gTestedRemoved) {
      // Repeat all tests with element removed from doc, should get same result.
      video.parentNode.removeChild(video);
      gTestedRemoved = true;
      gTestNum = 0;
    } else {
      // We're done, exit the test.
      window.close();
      return;
    }
  }
  gExpectedResult = gTests[gTestNum].result;
  gTestDescription = gTests[gTestNum].description;
  dump("Starting test " + gTestNum + " at " + gTests[gTestNum].url + "\n");
  video.src = gTests[gTestNum].url;
  video.load();
  gTestNum++;
}

function done() {
  netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
  // Undo change to access control check pref.
  var prefService = Components.classes["@mozilla.org/preferences-service;1"]
                               .getService(Components.interfaces.nsIPrefService);
  var branch = prefService.getBranch("media.");
  branch.setBoolPref("enforce_same_site_origin", gOldPref);
  opener.done();
}

</script>


</head>
<body onload="load();" onunload="done()">

  <!-- Change onloadedfirstframe to onloadeddata after bug 462570 lands -->
  <video id="video"
         onloadeddata="result('loaded');" 
         onerror="result('error');">
  </video>
</body>
</html>

